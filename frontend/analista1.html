<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Projetos</title>
    <link rel="stylesheet" href="assets/css/style.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        background: linear-gradient(120deg, #e0c3fc 0%, #8ec5fc 100%);
        min-height: 100vh;
        font-family: "Inter", Arial, sans-serif;
      }
      .container {
        display: flex;
        min-height: 100vh;
      }
      .sidebar {
        background: #1f1f2e;
        color: white;
        min-width: 220px;
        min-height: 100vh;
        padding: 30px 20px;
        border-radius: 0 10px 10px 0;
        box-shadow: 2px 0 8px rgba(0, 0, 0, 0.04);
      }
      .sidebar h2 {
        font-size: 1.5rem;
        margin-bottom: 2rem;
      }
      .sidebar nav a {
        color: white;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 18px;
        font-weight: 500;
        font-size: 1.08rem;
        border-radius: 6px;
        padding: 6px 8px;
        transition: background 0.2s;
      }
      .sidebar nav a:hover,
      .sidebar nav a.active {
        background: #29294d;
        color: #ffc107;
      }
      .main {
        flex: 1;
        padding: 40px 5vw 40px 5vw;
        background: transparent;
        min-width: 0;
      }
      .main-header h1 {
        font-size: 2rem;
        font-weight: 700;
      }
      .main-header p {
        color: #888;
        margin-bottom: 0;
      }
      .cards {
        display: flex;
        gap: 2rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
      }
      .card-status {
        flex: 1 1 200px;
        background: #fff;
        border-radius: 1rem;
        box-shadow: 0 1px 8px rgba(0, 0, 0, 0.07);
        padding: 1.5rem 1.2rem;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        min-width: 200px;
      }
      .card-status .label {
        font-size: 1rem;
        color: #888;
        margin-bottom: 0.5rem;
      }
      .card-status .value {
        font-size: 2.2rem;
        font-weight: 700;
        margin-bottom: 0.2rem;
      }
      .card-status.no-prazo .value {
        color: #43d391;
      }
      .card-status.alerta .value {
        color: #ffd600;
      }
      .card-status.fora-prazo .value {
        color: #ff5c5c;
      }
      .gantt-card {
        background: #fff;
        border-radius: 1rem;
        box-shadow: 0 1px 8px rgba(0, 0, 0, 0.07);
        padding: 2rem 1.5rem;
        margin-bottom: 2rem;
      }
      .projetos-lista {
        background: #fff;
        border-radius: 1rem;
        box-shadow: 0 1px 8px rgba(0, 0, 0, 0.07);
        padding: 2rem 1.5rem;
      }
      .projetos-lista h2 {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 1rem;
      }
      .projetos-lista ul {
        list-style-type: none;
        padding: 0;
        margin: 0;
      }
      .projetos-lista li {
        padding: 12px 0;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 1.05rem;
      }
      .projetos-lista li:last-child {
        border-bottom: none;
      }
      @media (max-width: 900px) {
        .main {
          padding: 30px 2vw;
        }
        .cards {
          flex-direction: column;
          gap: 1rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Sidebar -->
      <aside class="sidebar">
        <h2>Projetos AI</h2>
        <nav>
          <a href="index.html" class="active">
            <span class="material-icons">dashboard</span>Dashboard
          </a>
          <a href="novo-projeto.html">
            <span class="material-icons">add_circle</span>Novo Projeto
          </a>
          <a href="painel-admin.html">
            <span class="material-icons">admin_panel_settings</span>Painel Admin
          </a>
          <a href="analista.html">
            <span class="material-icons">description</span>Projetos
          </a>
          <a href="configuracoes.html">
            <span class="material-icons">settings</span>Configuração
          </a>
          <a href="#" id="btnLogout">
            <span class="material-icons">logout</span>Logout
          </a>
        </nav>
      </aside>

      <!-- Main -->
      <main class="main">
        <header class="main-header mb-4">
          <h1>Dashboard de Projetos</h1>
          <p>Status geral dos projetos e visão de prazos</p>
        </header>

        <!-- Cards de status -->
        <section class="cards mb-4">
          <div class="card-status no-prazo">
            <span class="label">No prazo</span>
            <span class="value" id="projetosNoPrazo">0</span>
          </div>
          <div class="card-status alerta">
            <span class="label">Em alerta</span>
            <span class="value" id="projetosAlerta">0</span>
          </div>
          <div class="card-status fora-prazo">
            <span class="label">Fora do prazo</span>
            <span class="value" id="projetosForaPrazo">0</span>
          </div>
        </section>

        <!-- Gráficos e Gantt -->
        <section class="row mb-4" style="display: flex; gap: 2rem">
          <div class="col-md-5" style="flex: 1; min-width: 280px">
            <div class="gantt-card">
              <h5 class="mb-3">Gantt dos Projetos</h5>
              <canvas id="ganttProjetos" height="120"></canvas>
            </div>
          </div>
          <div class="col-md-3" style="flex: 1; min-width: 220px">
            <div class="gantt-card">
              <h6 class="mb-3">Status dos Projetos</h6>
              <canvas id="graficoPizzaStatus"></canvas>
            </div>
          </div>
          <div class="col-md-4" style="flex: 1; min-width: 260px">
            <div class="gantt-card">
              <h6 class="mb-3">Analistas</h6>
              <table class="table table-sm align-middle" id="tabelaAnalistas">
                <thead>
                  <tr>
                    <th>Nome</th>
                    <th>Projetos</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Preenchido via JS -->
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Lista de projetos -->
        <section class="projetos-lista">
          <h2>Projetos</h2>
          <ul id="listaProjetos"></ul>
        </section>
      </main>
    </div>

    <!-- Modal Detalhes Analista -->
    <div
      class="modal fade"
      id="modalDetalhesAnalista"
      tabindex="-1"
      aria-labelledby="modalDetalhesAnalistaLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalDetalhesAnalistaLabel">
              Projetos do Analista
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Fechar"
            ></button>
          </div>
          <div class="modal-body">
            <table class="table table-bordered align-middle">
              <thead>
                <tr>
                  <th>Projeto</th>
                  <th>Status</th>
                  <th>% Evolução</th>
                  <th>Prognóstico</th>
                </tr>
              </thead>
              <tbody id="detalhesAnalistaBody">
                <!-- Preenchido via JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
      import { SUPABASE_URL, SUPABASE_KEY } from "./assets/js/env.js";

      const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

      // Verifica se o usuário está autenticado
      const {
        data: { user },
      } = await supabase.auth.getUser();
      if (!user) {
        alert("Sessão expirada. Faça login novamente.");
        window.location.href = "login.html";
      }

      // Logout
      document
        .getElementById("btnLogout")
        ?.addEventListener("click", async (e) => {
          e.preventDefault();
          await supabase.auth.signOut();
          localStorage.removeItem("user");
          window.location.href = "login.html";
        });

      // Carrega os projetos e preenche cards e Gantt
      async function carregarProjetos() {
        const { data: projetos, error } = await supabase
          .from("projetos")
          .select("*")
          .order("prazo", { ascending: true });

        if (error) {
          console.error("Erro ao carregar projetos:", error.message);
          document.getElementById("listaProjetos").innerHTML =
            "<li>Erro ao carregar projetos</li>";
          return;
        }

        const lista = document.getElementById("listaProjetos");
        lista.innerHTML = "";

        let ativos = 0,
          alerta = 0,
          foraPrazo = 0;
        const hoje = new Date();

        // Para o Gantt
        const labels = [];
        const duracoes = [];
        const cores = [];

        projetos.forEach((p) => {
          const prazo = new Date(p.prazo);
          const inicio = new Date(p.inicio || p.created_at || p.prazo);
          const diffDias = (prazo - hoje) / (1000 * 3600 * 24);
          let status = "✅ No prazo";
          let cor = "#43d391";

          if (diffDias <= 3 && diffDias > 0) {
            status = "⚠️ Alerta";
            alerta++;
            cor = "#ffd600";
          } else if (diffDias < 0) {
            status = "❌ Fora do prazo";
            foraPrazo++;
            cor = "#ff5c5c";
          } else {
            ativos++;
          }

          // Gantt
          labels.push(p.titulo);
          duracoes.push(
            Math.max(1, Math.round((prazo - inicio) / (1000 * 3600 * 24)))
          );
          cores.push(cor);

          // Lista
          const item = document.createElement("li");
          item.innerHTML = `
            <span>
              <strong>${p.titulo}</strong>
              <span class="text-muted small ms-2">${
                p.prazo ? new Date(p.prazo).toLocaleDateString() : ""
              }</span>
            </span>
            <span>${status}</span>
          `;
          lista.appendChild(item);
        });

        document.getElementById("projetosNoPrazo").textContent = ativos;
        document.getElementById("projetosAlerta").textContent = alerta;
        document.getElementById("projetosForaPrazo").textContent = foraPrazo;

        // Gantt Chart
        const ctx = document.getElementById("ganttProjetos").getContext("2d");
        if (window.ganttChart) window.ganttChart.destroy();
        window.ganttChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Duração (dias)",
                data: duracoes,
                backgroundColor: cores,
                borderRadius: 8,
              },
            ],
          },
          options: {
            indexAxis: "y",
            plugins: { legend: { display: false } },
            scales: { x: { beginAtZero: true } },
            responsive: true,
          },
        });

        // --- GRÁFICO DE PIZZA ---
        // Conte status
        const statusCount = {
          fora_prazo: 0,
          entregue: 0,
          backlog: 0,
          em_progresso: 0,
          teste: 0,
          cancelado: 0,
        };
        projetos.forEach((p) => {
          // Ajuste conforme seu campo de status real
          let s = (p.status || "").toLowerCase();
          if (s === "concluido" || s === "entregue") s = "entregue";
          if (s === "em progresso") s = "em_progresso";
          if (s === "pausado" || s === "cancelado" || s === "suspenso")
            s = "cancelado";
          if (statusCount[s] !== undefined) statusCount[s]++;
        });
        // Fora do prazo: já contado no loop anterior
        // Renderiza pizza
        const pizzaData = statusKeys.map((k) => statusCount[k]);
        const ctxPizza = document
          .getElementById("graficoPizzaStatus")
          .getContext("2d");
        if (window.pizzaChart) window.pizzaChart.destroy();
        window.pizzaChart = new Chart(ctxPizza, {
          type: "doughnut",
          data: {
            labels: statusLabels,
            datasets: [
              {
                data: pizzaData,
                backgroundColor: statusColors,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: { legend: { position: "bottom" } },
          },
        });

        // --- TABELA DE ANALISTAS ---
        // Simule agrupamento por analista (ajuste para seu banco)
        const analistas = {};
        projetos.forEach((p) => {
          const nome = p.analista || "Desconhecido";
          if (!analistas[nome]) analistas[nome] = [];
          analistas[nome].push(p);
        });
        const tbody = document.querySelector("#tabelaAnalistas tbody");
        tbody.innerHTML = "";
        Object.entries(analistas).forEach(([nome, lista]) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${nome}</td>
            <td>${lista.length}</td>
            <td><button class="btn btn-sm btn-primary btnDetalhesAnalista" data-nome="${nome}">Ver detalhes</button></td>
          `;
          tbody.appendChild(tr);
        });

        // Evento para abrir modal de detalhes
        document.querySelectorAll(".btnDetalhesAnalista").forEach((btn) => {
          btn.onclick = () => {
            const nome = btn.getAttribute("data-nome");
            const projetosAnalista = analistas[nome];
            const corpo = document.getElementById("detalhesAnalistaBody");
            corpo.innerHTML = "";
            projetosAnalista.forEach((p) => {
              // Simule percentual e prognóstico
              const perc = p.percentual || Math.floor(Math.random() * 100) + 1;
              const prazo = new Date(p.prazo);
              const hoje = new Date();
              const diasRestantes = Math.round(
                (prazo - hoje) / (1000 * 3600 * 24)
              );
              let progCor = "";
              let progTxt = "";
              if (diasRestantes <= 10 && perc < 80) {
                progCor = "bg-danger text-white";
                progTxt = "Atraso";
              } else if (perc >= 80 && perc < 100) {
                progCor = "bg-warning text-dark";
                progTxt = "Atenção";
              } else if (perc >= 100) {
                progCor = "bg-success text-white";
                progTxt = "OK";
              } else {
                progCor = "";
                progTxt = "";
              }
              corpo.innerHTML += `
                <tr>
                  <td>${p.titulo}</td>
                  <td>${p.status}</td>
                  <td>${perc}%</td>
                  <td><span class="badge ${progCor}">${progTxt}</span></td>
                </tr>
              `;
            });
            const modal = new bootstrap.Modal(
              document.getElementById("modalDetalhesAnalista")
            );
            modal.show();
          };
        });
      }

      // Função para ver detalhes do analista
      window.verDetalhesAnalista = async (analistaId) => {
        const { data: projetos, error } = await supabase
          .from("projetos")
          .select("*")
          .eq("responsavel_id", analistaId)
          .order("titulo", { ascending: true });

        if (error) {
          console.error(
            "Erro ao carregar projetos do analista:",
            error.message
          );
          return;
        }

        const detalhesBody = document.getElementById("detalhesAnalistaBody");
        detalhesBody.innerHTML = "";

        projetos.forEach((p) => {
          const row = document.createElement("tr");
          const prazo = new Date(p.prazo);
          const hoje = new Date();
          const diffDias = (prazo - hoje) / (1000 * 3600 * 24);
          let status = "No prazo";
          let prognostico = "Cumprindo";

          if (diffDias <= 3 && diffDias > 0) {
            status = "Em alerta";
            prognostico = "Atenção";
          } else if (diffDias < 0) {
            status = "Fora do prazo";
            prognostico = "Atrasado";
          }

          row.innerHTML = `
            <td>${p.titulo}</td>
            <td>${status}</td>
            <td>${p.evolucao || 0}%</td>
            <td>${prognostico}</td>
          `;
          detalhesBody.appendChild(row);
        });

        const modal = new bootstrap.Modal(
          document.getElementById("modalDetalhesAnalista")
        );
        modal.show();
      };

      carregarProjetos();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
