<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Projetos</title>
    <link rel="stylesheet" href="assets/css/style.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <style>
      .projetos-lista ul {
        list-style-type: none;
        padding: 0;
      }
      .projetos-lista li {
        padding: 10px;
        background: #fff;
        margin-bottom: 10px;
        border-radius: 6px;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Sidebar -->
      <aside class="sidebar">
        <h2>Projetos AI</h2>
        <nav>
          <a href="index.html"
            ><span class="material-icons">dashboard</span>Dashboard</a
          >
          <a href="novo-projeto.html"
            ><span class="material-icons">add_circle</span>Novo Projeto</a
          >
          <a href="painel-admin.html"
            ><span class="material-icons">admin_panel_settings</span>Painel
            Admin</a
          >
          <a href="analista.html"
            ><span class="material-icons">description</span>Projetos</a
          >
          <a href="configuracoes.html"
            ><span class="material-icons">description</span>Configuração</a
          >
          <a href="#" id="btnLogout"
            ><span class="material-icons">logout</span>Logout</a
          >
        </nav>
      </aside>

      <!-- Main -->
      <main class="main">
        <header class="main-header">
          <h1>Dashboard</h1>
          <p>Status geral dos projetos</p>
        </header>

        <!-- Cards de status -->
        <section class="cards">
          <div class="card" id="statusProjetos">
            <h3>Status</h3>
            <p>Carregando...</p>
          </div>
        </section>

        <!-- Lista de projetos -->
        <section class="projetos-lista">
          <h2>Projetos</h2>
          <ul id="listaProjetos"></ul>
        </section>
      </main>
    </div>

    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
      import { SUPABASE_URL, SUPABASE_KEY } from "./assets/js/env.js";

      const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

      // Verifica se o usuário está autenticado
      const {
        data: { user },
      } = await supabase.auth.getUser();
      if (!user) {
        alert("Sessão expirada. Faça login novamente.");
        window.location.href = "login.html";
      }

      // Logout
      document
        .getElementById("btnLogout")
        ?.addEventListener("click", async (e) => {
          e.preventDefault();
          await supabase.auth.signOut();
          localStorage.removeItem("user");
          window.location.href = "login.html";
        });

      // Carrega os projetos
      async function carregarProjetos() {
        const { data: projetos, error } = await supabase
          .from("projetos")
          .select("*")
          .order("prazo", { ascending: true });

        if (error) {
          console.error("Erro ao carregar projetos:", error.message);
          document.getElementById("listaProjetos").innerHTML =
            "<li>Erro ao carregar projetos</li>";
          return;
        }

        const lista = document.getElementById("listaProjetos");
        const statusBox = document.getElementById("statusProjetos");
        lista.innerHTML = "";

        let ativos = 0,
          alerta = 0,
          foraPrazo = 0;
        const hoje = new Date();

        projetos.forEach((p) => {
          const prazo = new Date(p.prazo);
          const diffDias = (prazo - hoje) / (1000 * 3600 * 24);
          let status = "✅ No prazo";

          if (diffDias <= 3 && diffDias > 0) {
            status = "⚠️ Alerta";
            alerta++;
          } else if (diffDias < 0) {
            status = "❌ Fora do prazo";
            foraPrazo++;
          } else {
            ativos++;
          }

          const item = document.createElement("li");
          item.textContent = `${p.titulo} — ${status}`;
          lista.appendChild(item);
        });

        statusBox.innerHTML = `
        <h3>Status Geral</h3>
        <p>✅ No prazo: ${ativos}</p>
        <p>⚠️ Alerta: ${alerta}</p>
        <p>❌ Fora do prazo: ${foraPrazo}</p>
      `;
      }

      carregarProjetos();
    </script>
  </body>
</html>
