<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Projetos</title>
    <link rel="stylesheet" href="assets/css/style.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        background: linear-gradient(120deg, #e0c3fc 0%, #8ec5fc 100%);
        min-height: 100vh;
        font-family: "Inter", Arial, sans-serif;
      }
      .container {
        display: flex;
        min-height: 100vh;
      }
      .sidebar {
        background: #1f1f2e;
        color: white;
        min-width: 220px;
        min-height: 100vh;
        padding: 30px 20px;
        border-radius: 0 10px 10px 0;
        box-shadow: 2px 0 8px rgba(0, 0, 0, 0.04);
      }
      .sidebar h2 {
        font-size: 1.5rem;
        margin-bottom: 2rem;
      }
      .sidebar nav a {
        color: white;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 18px;
        font-weight: 500;
        font-size: 1.08rem;
        border-radius: 6px;
        padding: 6px 8px;
        transition: background 0.2s;
      }
      .sidebar nav a:hover,
      .sidebar nav a.active {
        background: #29294d;
        color: #ffc107;
      }
      .main {
        flex: 1;
        padding: 40px 5vw 40px 5vw;
        background: transparent;
        min-width: 0;
      }
      .main-header h1 {
        font-size: 2rem;
        font-weight: 700;
      }
      .main-header p {
        color: #888;
        margin-bottom: 0;
      }
      .dashboard-section {
        display: flex;
        gap: 20px;
        margin-top: 30px;
      }
      .chart-box {
        flex: 2;
        background: #fff;
        padding: 20px;
        border-radius: 8px;
      }
      .side-panels {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      .side-panel {
        background: #fff;
        padding: 15px;
        border-radius: 8px;
      }
      .side-panel h3 {
        margin-top: 0;
      }
      table {
        width: 100%;
        font-size: 0.9em;
        border-collapse: collapse;
      }
      table,
      th,
      td {
        border: 1px solid #ddd;
      }
      th,
      td {
        padding: 6px 8px;
        text-align: left;
      }

      /* Estilos para o modal */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background-color: white;
        border-radius: 8px;
        width: 80%;
        max-width: 900px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      }

      .modal-header {
        padding: 16px 20px;
        background: #1f1f2e;
        color: white;
        border-radius: 8px 8px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-header h5 {
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .modal-body {
        padding: 20px;
      }

      .close-modal {
        background: none;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
      }

      @media (max-width: 900px) {
        .main {
          padding: 30px 2vw;
        }
        .dashboard-section {
          flex-direction: column;
        }
        .modal-content {
          width: 95%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Sidebar -->
      <aside class="sidebar">
        <h2>Projetos AI</h2>
        <nav>
          <a href="index.html" class="active">
            <span class="material-icons">dashboard</span>Dashboard
          </a>
          <a href="novo-projeto.html">
            <span class="material-icons">add_circle</span>Novo Projeto
          </a>
          <a href="painel-admin.html">
            <span class="material-icons">admin_panel_settings</span>Painel Admin
          </a>
          <a href="analista.html">
            <span class="material-icons">description</span>Projetos
          </a>
          <a href="configuracoes.html">
            <span class="material-icons">settings</span>Configura√ß√£o
          </a>
          <a href="#" id="btnLogout">
            <span class="material-icons">logout</span>Logout
          </a>
        </nav>
      </aside>

      <main class="main">
        <header class="main-header mb-4">
          <h1>Dashboard de Projetos</h1>
          <p>Status geral dos projetos e vis√£o de prazos</p>
        </header>

        <div class="dashboard-section">
          <!-- Gantt -->
          <div class="chart-box">
            <h3>üìÖ Cronograma Gantt</h3>
            <canvas id="ganttChart" height="180"></canvas>
          </div>
          <!-- Pain√©is laterais -->
          <div class="side-panels">
            <div class="side-panel">
              <h3>üìä Status dos Projetos</h3>
              <canvas id="statusChart"></canvas>
            </div>
            <div class="side-panel">
              <h3>üë§ Analistas</h3>
              <table id="analistasTable">
                <thead>
                  <tr>
                    <th>Analista</th>
                    <th>Total Projetos</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Modal Detalhes Analista -->
    <div class="modal" id="modalDetalhesAnalista">
      <div class="modal-content">
        <div class="modal-header">
          <h5>
            <span class="material-icons align-middle me-2">person</span>
            Projetos do Analista: <span id="nomeAnalistaModal"></span>
          </h5>
          <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>Projeto</th>
                  <th>Status</th>
                  <th>% Evolu√ß√£o</th>
                  <th>Progn√≥stico</th>
                </tr>
              </thead>
              <tbody id="detalhesAnalistaBody">
                <!-- Preenchido via JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
      import { SUPABASE_URL, SUPABASE_KEY } from "./assets/js/env.js";

      const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

      // Verifica se o usu√°rio est√° autenticado
      const {
        data: { user },
      } = await supabase.auth.getUser();
      if (!user) {
        alert("Sess√£o expirada. Fa√ßa login novamente.");
        window.location.href = "login.html";
      }

      // Logout
      document
        .getElementById("btnLogout")
        ?.addEventListener("click", async (e) => {
          e.preventDefault();
          await supabase.auth.signOut();
          localStorage.removeItem("user");
          window.location.href = "login.html";
        });

      // --- Carregar e renderizar dados ---
      let projetos = [];
      let analistasMap = {};

      async function carregarProjetos() {
        // Busca dados do Supabase (ajuste para Firebase se necess√°rio)
        const { data, error } = await supabase
          .from("projetos")
          .select("*")
          .order("prazo", { ascending: true });

        if (error) {
          alert("Erro ao carregar projetos: " + error.message);
          return;
        }
        projetos = data || [];
        renderGantt();
        renderStatusChart();
        renderAnalistasTable();
      }

      // === Gr√°fico Gantt ===
      function renderGantt() {
        const labels = projetos.map((p) => p.titulo);
        const durations = projetos.map((p) => {
          const start = new Date(p.data_inicio || p.created_at || p.prazo);
          const end = new Date(p.data_fim || p.prazo);
          const duration = Math.round((end - start) / (1000 * 60 * 60 * 24));
          return duration > 0 ? duration : 1;
        });
        const colors = projetos.map((p) => {
          const prazo = new Date(p.prazo);
          const hoje = new Date();
          const diffDias = (prazo - hoje) / (1000 * 3600 * 24);
          if (diffDias <= 3 && diffDias > 0) return "#ffd600";
          if (diffDias < 0) return "#ff5c5c";
          return "#43d391";
        });

        const ctx = document.getElementById("ganttChart").getContext("2d");
        if (window.ganttChart instanceof Chart) window.ganttChart.destroy();
        window.ganttChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels,
            datasets: [
              {
                label: "Dura√ß√£o (dias)",
                data: durations,
                backgroundColor: colors,
                borderRadius: 8,
              },
            ],
          },
          options: {
            indexAxis: "y",
            plugins: { legend: { display: false } },
            scales: { x: { beginAtZero: true } },
            responsive: true,
          },
        });
      }

      // === Gr√°fico de Status ===
      function renderStatusChart() {
        const statusLabels = [
          "Fora do prazo",
          "Entregue",
          "Backlog",
          "Em processo",
          "Teste",
          "Cancelado/Suspenso",
        ];
        const statusKeys = [
          "fora_prazo",
          "entregue",
          "backlog",
          "em_progresso",
          "teste",
          "cancelado",
        ];
        const statusColors = [
          "#ff5c5c",
          "#43d391",
          "#ffd600",
          "#42a5f5",
          "#ab47bc",
          "#bdbdbd",
        ];
        const statusCount = {
          fora_prazo: 0,
          entregue: 0,
          backlog: 0,
          em_progresso: 0,
          teste: 0,
          cancelado: 0,
        };

        projetos.forEach((p) => {
          let s = (p.status || "").toLowerCase();
          if (s === "concluido" || s === "entregue") s = "entregue";
          if (s === "em progresso") s = "em_progresso";
          if (s === "pausado" || s === "cancelado" || s === "suspenso")
            s = "cancelado";
          if (statusCount[s] !== undefined) statusCount[s]++;
          // Fora do prazo: se prazo j√° passou e n√£o est√° entregue/cancelado
          if (s !== "entregue" && s !== "cancelado") {
            const prazo = new Date(p.prazo);
            if (prazo < new Date()) statusCount["fora_prazo"]++;
          }
        });

        const ctx = document.getElementById("statusChart").getContext("2d");
        if (window.statusChart) window.statusChart.destroy();

        // Se n√£o houver dados, mostra mensagem
        const totalProjetos = Object.values(statusCount).reduce(
          (a, b) => a + b,
          0
        );
        if (totalProjetos === 0) {
          ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
          ctx.font = "16px Arial";
          ctx.fillStyle = "#888";
          ctx.textAlign = "center";
          ctx.fillText(
            "Nenhum dado para exibir",
            ctx.canvas.width / 2,
            ctx.canvas.height / 2
          );
          return;
        }

        window.statusChart = new Chart(ctx, {
          type: "pie",
          data: {
            labels: statusLabels,
            datasets: [
              {
                data: statusKeys.map((k) => statusCount[k]),
                backgroundColor: statusColors,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: { legend: { position: "bottom" } },
          },
        });
      }

      // === Tabela de Analistas ===
      function renderAnalistasTable() {
        analistasMap = {};
        projetos.forEach((p) => {
          const nome = p.analista || "Desconhecido";
          if (!analistasMap[nome]) analistasMap[nome] = [];
          analistasMap[nome].push(p);
        });
        const tbody = document.querySelector("#analistasTable tbody");
        tbody.innerHTML = "";

        const nomesAnalistas = Object.keys(analistasMap);

        if (nomesAnalistas.length === 0) {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td colspan="3" style="text-align:center; color:#888;">Nenhum analista encontrado</td>`;
          tbody.appendChild(tr);
          return;
        }

        nomesAnalistas.forEach((nome) => {
          const lista = analistasMap[nome];
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${nome}</td>
            <td>${lista.length}</td>
            <td><button class="btn btn-sm btn-primary btnDetalhesAnalista" data-nome="${nome}">Ver detalhes</button></td>
          `;
          tbody.appendChild(tr);
        });

        // Evento para abrir modal de detalhes
        document.querySelectorAll(".btnDetalhesAnalista").forEach((btn) => {
          btn.onclick = () => {
            const nome = btn.getAttribute("data-nome");
            document.getElementById("nomeAnalistaModal").textContent = nome;

            const projetosAnalista = analistasMap[nome];
            const corpo = document.getElementById("detalhesAnalistaBody");
            corpo.innerHTML = "";
            projetosAnalista.forEach((p) => {
              const perc = p.percentual || Math.floor(Math.random() * 100) + 1;
              const prazo = new Date(p.prazo);
              const hoje = new Date();
              const diasRestantes = Math.round(
                (prazo - hoje) / (1000 * 3600 * 24)
              );
              let progCor = "";
              let progTxt = "";
              if (diasRestantes <= 10 && perc < 80) {
                progCor = "bg-danger text-white";
                progTxt = "Atraso";
              } else if (perc >= 80 && perc < 100) {
                progCor = "bg-warning text-dark";
                progTxt = "Aten√ß√£o";
              } else if (perc >= 100) {
                progCor = "bg-success text-white";
                progTxt = "OK";
              } else {
                progCor = "";
                progTxt = "";
              }
              corpo.innerHTML += `
                <tr>
                  <td>${p.titulo}</td>
                  <td>${p.status}</td>
                  <td>${perc}%</td>
                  <td><span class="badge ${progCor}">${progTxt}</span></td>
                </tr>
              `;
            });

            // Mostrar o modal
            document.getElementById("modalDetalhesAnalista").style.display =
              "flex";
          };
        });
      }

      // Fechar modal quando clicar no bot√£o de fechar
      document.querySelector(".close-modal").onclick = function () {
        document.getElementById("modalDetalhesAnalista").style.display = "none";
      };

      // Fechar modal quando clicar fora do conte√∫do
      window.onclick = function (event) {
        const modal = document.getElementById("modalDetalhesAnalista");
        if (event.target === modal) {
          modal.style.display = "none";
        }
      };

      // Inicializa
      carregarProjetos();
    </script>
  </body>
</html>
